# Изменения в реализации аудита

## Обзор

Реализована асинхронная обработка событий аудита с использованием очередей внутри каждой реализации наблюдателя. Это решает проблему блокировки обработки HTTP-запросов при выполнении операций аудита.

## Основные изменения

### 1. FileObserver (`internal/audit/file_observer.go`)

- Добавлены поля: `eventChan`, `done`, `wg` для асинхронной обработки
- Реализован метод `processEvents()` для обработки событий из очереди
- Добавлен новый конструктор `NewFileObserverWithBufferSize()` для настройки размера буфера
- Метод `Notify()` теперь неблокирующий - просто помещает событие в очередь
- Добавлен метод `Close()` для корректного завершения работы

### 2. URLObserver (`internal/audit/url_observer.go`)

- Аналогичные изменения, как в FileObserver
- Реализован метод `sendToURL()` для фактической отправки данных
- Добавлен новый конструктор `NewURLObserverWithBufferSize()`

### 3. Интерфейс Observer (`internal/audit/observer.go`)

- Добавлен метод `Close()` к интерфейсу для обеспечения корректного завершения работы

### 4. Auditor (`internal/handler/audit_middleware.go`)

- Добавлен метод `Close()` для завершения работы всех наблюдателей

### 5. Основное приложение (`cmd/server/main.go`)

- Используются новые конструкторы с настраиваемым размером буфера
- Функция завершения работы аудита добавлена в массив `finish` для унифицированной обработки

## Преимущества новой реализации

1. **Асинхронность**: HTTP-запросы не блокируются операциями аудита
2. **Изоляция**: Сбои в одном наблюдателе не влияют на другие
3. **Гибкость**: Настраиваемый размер буфера для каждого наблюдателя
4. **Надежность**: Корректное завершение работы с обработкой оставшихся событий

## Настройка

Размеры буферов можно настроить в `cmd/server/main.go`:
- FileObserver: 1000 событий (подходит для высокой нагрузки на запись)
- URLObserver: 500 событий (меньший размер из-за потенциальных задержек сети)

## Обновленные тесты

Тесты были обновлены для работы с асинхронной реализацией:

### FileObserver тесты:
- `TestFileObserver_Notify`: Проверяет базовую функциональность с ожиданием асинхронной обработки
- `TestFileObserver_ConcurrentAccess`: Проверяет конкурентную запись с увеличенным временем ожидания
- `TestFileObserver_QueueOverflow`: Новый тест для проверки переполнения очереди
- `TestFileObserver_Close`: Новый тест для проверки корректного завершения работы

### URLObserver тесты:
- `TestURLObserver_Notify`: Обновлен для асинхронной обработки с мьютексом для безопасности
- `TestURLObserver_ServerError`: Обновлен с корректным завершением работы
- `TestURLObserver_InvalidURL`: Обновлен - теперь не возвращает ошибку немедленно из-за асинхронности
- `TestURLObserver_ConcurrentAccess`: Обновлен с увеличенным временем ожидания
- `TestURLObserver_QueueOverflow`: Новый тест для проверки переполнения очереди
- `TestURLObserver_Close`: Новый тест для проверки корректного завершения работы

## Будущие улучшения

1. Добавление метрик производительности для каждой очереди
2. Реализация механизма повторных попыток для URLObserver
3. Пакетная обработка событий для уменьшения операций ввода-вывода
4. Адаптивный размер буфера в зависимости от нагрузки